<div id="har-modal-app" class="har-modal-wrapper">
  <style>
    .har-modal-wrapper {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .har-modal-content {
      background-color: #0f172a;
      border: 1px solid #475569;
      border-radius: 0.75rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 90vw;
      height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .har-modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid #475569;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #1e293b;
    }

    .har-modal-header h2 {
      margin: 0;
      font-size: 1.25rem;
      color: #f1f5f9;
    }

    .har-modal-close {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: transparent;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      border-radius: 0.375rem;
      transition: all 0.2s;
    }

    .har-modal-close:hover {
      background-color: #334155;
      color: #f1f5f9;
    }

    .har-modal-close svg {
      width: 24px;
      height: 24px;
    }

    .har-modal-body {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .har-modal-tabs {
      display: flex;
      border-bottom: 1px solid #475569;
      padding: 0 1.5rem;
      background-color: #1e293b;
    }

    .har-modal-tab {
      padding: 0.75rem 1rem;
      background: transparent;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      font-size: 0.875rem;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .har-modal-tab:hover {
      color: #f1f5f9;
    }

    .har-modal-tab.active {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
    }

    .har-modal-content-section {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .upload-section {
      padding: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .upload-box {
      border: 2px dashed #475569;
      border-radius: 0.75rem;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background-color: rgba(30, 41, 59, 0.5);
      width: 100%;
      max-width: 400px;
    }

    .upload-box:hover {
      border-color: #3b82f6;
      background-color: rgba(30, 41, 59, 0.8);
    }

    .upload-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 1rem;
      color: #3b82f6;
    }

    .upload-box h3 {
      margin: 0 0 0.5rem;
      font-size: 1.125rem;
      color: #f1f5f9;
    }

    .upload-box p {
      margin: 0 0 1rem;
      color: #94a3b8;
      font-size: 0.875rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      background-color: #3b82f6;
      border: none;
      border-radius: 0.375rem;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      background-color: #2563eb;
    }

    .btn-secondary {
      background-color: #22c55e;
    }

    .btn-secondary:hover {
      background-color: #16a34a;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .preview-section {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      padding: 1rem;
    }

    .preview-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .preview-item {
      padding: 0.75rem;
      background-color: #1e293b;
      border: 1px solid #334155;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .preview-item:hover {
      background-color: #334155;
      border-color: #3b82f6;
    }

    .preview-item.selected {
      background-color: rgba(59, 130, 246, 0.15);
      border-color: #3b82f6;
    }

    .preview-method {
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 600;
      min-width: 50px;
      text-align: center;
      background-color: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .preview-url {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #cbd5e1;
      font-size: 0.875rem;
    }

    .preview-footer {
      padding-top: 1rem;
      border-top: 1px solid #475569;
      display: flex;
      gap: 1rem;
      justify-content: space-between;
    }

    .preview-count {
      color: #94a3b8;
      font-size: 0.875rem;
    }

    .empty-message {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #94a3b8;
      text-align: center;
    }
  </style>

  <div class="har-modal-content">
    <div class="har-modal-header">
      <h2>Add HAR File</h2>
      <button @click="closeModal" class="har-modal-close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="har-modal-tabs" v-if="requests.length > 0">
      <button
        @click="activeTab = 'upload'"
        :class="['har-modal-tab', { active: activeTab === 'upload' }]"
      >
        Upload
      </button>
      <button
        @click="activeTab = 'preview'"
        :class="['har-modal-tab', { active: activeTab === 'preview' }]"
      >
        Preview ({{ requests.length }})
      </button>
    </div>

    <div class="har-modal-body">
      <!-- Upload Tab -->
      <div v-if="activeTab === 'upload'" class="har-modal-content-section">
        <div class="upload-section">
          <div class="upload-box" @dragover="dragover = true" @dragleave="dragover = false" @drop="handleDrop">
            <input
              type="file"
              accept=".har"
              @change="handleFileChange"
              style="display: none"
              ref="fileInput"
            >
            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
            </svg>
            <h3>Upload HAR File</h3>
            <p>Drag and drop or click to select</p>
            <button @click="$refs.fileInput.click()" class="btn">Choose File</button>
          </div>
        </div>
      </div>

      <!-- Preview Tab -->
      <div v-else-if="activeTab === 'preview'" class="har-modal-content-section preview-section">
        <div v-if="requests.length === 0" class="empty-message">
          No requests loaded
        </div>
        <div v-else class="preview-list">
          <div
            v-for="(request, idx) in requests"
            :key="request._id"
            :class="['preview-item', { selected: selectedIndices.has(idx) }]"
            @click="toggleSelection(idx)"
          >
            <span class="preview-method">{{ request.request.method }}</span>
            <span class="preview-url" :title="request.request.url">
              {{ truncateUrl(request.request.url) }}
            </span>
          </div>
        </div>
        <div class="preview-footer">
          <span class="preview-count">{{ selectedIndices.size }} of {{ requests.length }} selected</span>
          <button
            @click="saveSelectedEntries"
            :disabled="selectedIndices.size === 0"
            class="btn btn-secondary"
          >
            Save Selected
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script>
const { createApp, ref, computed } = Vue;

const app = createApp({
  setup() {
    const projectId = '<%= @project.id %>';
    const activeTab = ref('upload');
    const requests = ref([]);
    const selectedIndices = ref(new Set());
    const dragover = ref(false);
    const fileInput = ref(null);

    const handleFileChange = (event) => {
      const file = event.target.files[0];
      if (file) {
        parseHarFile(file);
      }
    };

    const handleDrop = (event) => {
      event.preventDefault();
      dragover.value = false;
      const file = event.dataTransfer.files[0];
      if (file && file.name.endsWith('.har')) {
        parseHarFile(file);
      }
    };

    const parseHarFile = (file) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const har = JSON.parse(e.target.result);
          const entries = har.log && har.log.entries ? har.log.entries : [];

          requests.value = entries.map((entry, idx) => ({
            _id: `entry-${Date.now()}-${idx}`,
            _index: idx,
            _harName: file.name,
            startedDateTime: entry.startedDateTime || new Date().toISOString(),
            time: entry.time || 0,
            request: {
              method: entry.request.method || 'GET',
              url: entry.request.url || '',
              headers: entry.request.headers || [],
              postData: entry.request.postData || {}
            },
            response: {
              status: entry.response.status || 0,
              statusText: entry.response.statusText || 'Unknown',
              headers: entry.response.headers || [],
              content: {
                size: entry.response.content.size || 0,
                mimeType: entry.response.content.mimeType || 'application/octet-stream',
                text: entry.response.content.text || ''
              }
            }
          }));

          selectedIndices.value.clear();
          activeTab.value = 'preview';
        } catch (error) {
          alert('Error parsing HAR file: ' + error.message);
        }
      };
      reader.readAsText(file);
    };

    const truncateUrl = (url) => {
      try {
        const urlObj = new URL(url);
        const parts = urlObj.pathname.split('/').filter(p => p);
        return parts.slice(-2).join('/') || urlObj.hostname;
      } catch {
        return url.substring(0, 50);
      }
    };

    const toggleSelection = (idx) => {
      if (selectedIndices.value.has(idx)) {
        selectedIndices.value.delete(idx);
      } else {
        selectedIndices.value.add(idx);
      }
    };

    const saveSelectedEntries = async () => {
      const selected = Array.from(selectedIndices.value).map(idx => requests.value[idx]);

      if (selected.length === 0) {
        alert('Please select entries to save');
        return;
      }

      try {
        const response = await fetch(
          `/projects/${projectId}/db_scrappers/save_har_entries`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
              entries: selected,
              file_name: 'imported_har.har'
            })
          }
        );

        const data = await response.json();
        if (data.success) {
          alert('HAR entries saved successfully!');
          closeModal();
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error saving entries: ' + error.message);
      }
    };

    const closeModal = () => {
      const modal = document.querySelector('#har-modal-app');
      if (modal && modal.parentElement) {
        modal.parentElement.removeChild(modal);
      }
    };

    return {
      projectId,
      activeTab,
      requests,
      selectedIndices,
      dragover,
      fileInput,
      handleFileChange,
      handleDrop,
      truncateUrl,
      toggleSelection,
      saveSelectedEntries,
      closeModal
    };
  }
});

app.mount('#har-modal-app');
</script>
