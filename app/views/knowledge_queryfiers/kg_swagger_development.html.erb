<div class="chat-app">
  <!-- Sidepanel -->
  <div class="sidepanel">
    <div class="sidepanel-header">
      <button id="new-chat-btn">➕ New Chat</button>
      <h2>Sessions</h2>
      <ul id="session-list">
        <li class="session active">Session 1</li>
      </ul>
    </div>

    <div class="sidepanel-footer">
      <div class="user-info">
        <div class="avatar"></div>
        <div class="name">Gaurav R</div>
      </div>
      <div class="settings">⚙️ Settings</div>
    </div>
  </div>

  <!-- Chat panel -->
  <div class="chat-panel">
    <turbo-frame id="chat-messages" class="chat-messages">
      <!-- Messages will append here -->
    </turbo-frame>

    <div class="chat-input">
      <%= form_with url: kg_swagger_dev_agent_project_path(@project),
                    method: :post,
                    data: { turbo_stream: true},
                    html: { style: "display: contents", id: "chat-form" } do |f| %>

        <%= f.hidden_field :session_id, value: 1, id: "session-id" %>
        <%= f.hidden_field :messages, value: "[]", id: "messages-field" %>
        <%= f.text_field :message, placeholder: "Enter your message here", id: "message-input" %>
        <%= f.submit "Send" %>
      <% end %>
    </div>
  </div>
</div>

<script>
  // store all sessions in memory (id → messages)
  const sessions = { 1: [] };
  let activeSession = 1;
  document.querySelector("#session-id").value = activeSession;

  const sessionList = document.getElementById("session-list");
  const chatMessages = document.getElementById("chat-messages");
  const messagesField = document.getElementById("messages-field");
  const messageInput = document.getElementById("message-input");
  const chatForm = document.getElementById("chat-form");

  function renderMessages() {
    chatMessages.innerHTML = sessions[activeSession]
      .map(m => `<div class="chat-message ${m.role}">
                   <span class="role">${m.role}:</span>
                   <span class="content">${m.content}</span>
                 </div>`)
      .join("");
  }

  function setActiveSession(id) {
    activeSession = id;
    document.querySelectorAll(".session").forEach(li => li.classList.remove("active"));
    document.querySelector(`.session[data-id="${id}"]`).classList.add("active");
    document.querySelector("#session-id").value = activeSession;
    renderMessages();
  }

  // Handle New Chat
  document.getElementById("new-chat-btn").addEventListener("click", () => {
    const newId = Object.keys(sessions).length + 1;
    sessions[newId] = []

    const li = document.createElement("li");
    li.textContent = `Session ${newId}`;
    li.className = "session";
    li.dataset.id = newId;
    sessionList.appendChild(li);

    li.addEventListener("click", () => setActiveSession(newId));

    setActiveSession(newId);
  });

  // Add click listeners to existing sessions
  document.querySelectorAll("#session-list .session").forEach(li => {
    li.dataset.id = 1; // initial session
    li.addEventListener("click", () => setActiveSession(1));
  });

  // Before submit → push user msg + update hidden messages field
  chatForm.addEventListener("submit", (e) => {
    const inputVal = messageInput.value.trim();
    if (inputVal !== "") {
      // add user message to session
      sessions[activeSession].push({ role: "user", content: inputVal });

      // update hidden field with full conversation
      messagesField.value = JSON.stringify(sessions[activeSession]);

      renderMessages();
      messageInput.value = "";
    }
  });
</script>
<style>
    .chat-app {
  display: flex;
  height: 100vh;
  font-family: sans-serif;

  .sidepanel {
    width: 250px;
    background-color: cadetblue;
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: space-between;

    .sidepanel-header {
      padding: 1rem;

      button {
        width: 100%;
        margin-bottom: 1rem;
        padding: 0.5rem;
        border: none;
        border-radius: 6px;
        background: white;
        color: cadetblue;
        font-weight: bold;
        cursor: pointer;

        &:hover {
          background: #e2e2e2;
        }
      }

      h2 {
        margin: 0 0 0.5rem;
        font-size: 1rem;
        font-weight: bold;
      }

      ul {
        list-style: none;
        padding: 0;

        .session {
          background: rgba(255, 255, 255, 0.1);
          padding: 0.5rem;
          margin-bottom: 0.5rem;
          border-radius: 4px;
          cursor: pointer;

          &.active {
            background: rgba(255, 255, 255, 0.3);
            font-weight: bold;
          }
        }
      }
    }

    .sidepanel-footer {
      padding: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.4);
      display: flex;
      justify-content: space-between;
      align-items: center;

      .user-info {
        display: flex;
        align-items: center;

        .avatar {
          width: 32px;
          height: 32px;
          background: white;
          border-radius: 50%;
          margin-right: 0.5rem;
        }
      }

      .settings {
        cursor: pointer;
        font-size: 0.9rem;

        &:hover {
          text-decoration: underline;
        }
      }
    }
  }

  .chat-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #f8f9fa;

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;

      .chat-message {
        margin-bottom: 0.75rem;

        .role {
          font-weight: bold;
          margin-right: 0.5rem;
        }

        &.user .role {
          color: blue;
        }

        &.agent .role {
          color: green;
        }
      }
      .chat-message.system {
        display: none;
      }
    }

    .chat-input {
      display: flex;
      padding: 0.75rem;
      border-top: 1px solid #ccc;
      background: white;

      input[type="text"] {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-right: 0.5rem;
      }

      input[type="submit"] {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        background: cadetblue;
        color: white;
        cursor: pointer;

        &:hover {
          background: #2f6f74;
        }
      }
    }
  }
}
</style>